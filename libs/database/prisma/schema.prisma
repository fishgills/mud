// Prisma schema for the dungeon crawler game engine
// This schema covers Player, WorldTile, Monster, WeatherState, etc.
// Note: Biome definitions are managed in TypeScript (@mud/constants BiomeId enum)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GuildTradeDirection {
  BUY
  SELL
}

enum ItemType {
  WEAPON
  ARMOR
}

enum AnnouncementStatus {
  PENDING
  ANNOUNCED
  EXPIRED
}

model GameState {
  id        Int      @id @default(autoincrement())
  tick      Int      @default(0)
  gameHour  Int      @default(0) // 0-23
  gameDay   Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Player {
  id                 Int                  @id @default(autoincrement())
  name               String
  x                  Int // X coordinate
  y                  Int // Y coordinate
  isInHq             Boolean              @default(false) // Indicates player is in the HQ zone outside the world map
  lastWorldX         Int? // Last known world X position before entering HQ
  lastWorldY         Int? // Last known world Y position before entering HQ
  lastHqEnterAt      DateTime? // Timestamp for most recent HQ entry
  hp                 Int // Hit points (current health)
  maxHp              Int                  @default(100) // Maximum health
  strength           Int                  @default(10) // Strength attribute (1-20)
  agility            Int                  @default(10) // Agility attribute (1-20)
  health             Int                  @default(10) // Health attribute (1-20, affects max HP)
  gold               Int                  @default(0)
  xp                 Int                  @default(0)
  level              Int                  @default(1)
  skillPoints        Int                  @default(0)
  isAlive            Boolean              @default(true)
  isCreationComplete Boolean              @default(false) // Tracks if character creation is complete (no more rerolls/complete allowed)
  lastAction         DateTime             @default(now())
  hasMoved           Boolean              @default(false)
  hasBattled         Boolean              @default(false)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  worldTile          WorldTile?           @relation("PlayerLocation", fields: [worldTileId], references: [id])
  worldTileId        Int?
  party              Party?               @relation(fields: [partyId], references: [id])
  partyId            Int?
  partyMembers       PartyMember[]
  playerItems        PlayerItem[]
  slackUser          SlackUser?
  guildReceipts      TransactionReceipt[]
  feedbacks          Feedback[]
  // Future: discordUsers DiscordUser[], webUsers WebUser[], etc.
}

model SlackUser {
  id        Int      @id @default(autoincrement())
  teamId    String // Slack workspace/team ID (e.g., "TB1QW3SQHU")
  userId    String // Slack user ID (e.g., "UB389SP46")
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model WorldSeed {
  id                     Int      @id @default(autoincrement())
  seed                   Int      @unique
  heightSeed             Int
  temperatureSeed        Int
  moistureSeed           Int
  heightScale            Float    @default(0.01)
  temperatureScale       Float    @default(0.008)
  moistureScale          Float    @default(0.012)
  heightOctaves          Int      @default(4)
  temperatureOctaves     Int      @default(3)
  moistureOctaves        Int      @default(3)
  heightPersistence      Float    @default(0.5)
  temperaturePersistence Float    @default(0.6)
  moisturePersistence    Float    @default(0.4)
  heightLacunarity       Float    @default(2.0)
  temperatureLacunarity  Float    @default(2.1)
  moistureLacunarity     Float    @default(1.9)
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model WorldTile {
  id          Int      @id @default(autoincrement())
  x           Int
  y           Int
  biomeId     Int // References BiomeId enum from @mud/constants
  biomeName   String // Store biome name for faster queries
  description String?
  height      Float // 0-1 height value from terrain noise
  temperature Float // 0-1 temperature value from temperature noise
  moisture    Float // 0-1 moisture value from moisture noise
  seed        Int // World seed used to generate this tile
  chunkX      Int // Chunk X coordinate (x / 50)
  chunkY      Int // Chunk Y coordinate (y / 50)
  players     Player[] @relation("PlayerLocation")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([x, y])
  @@index([chunkX, chunkY])
  @@index([seed])
}

model Monster {
  id         Int      @id @default(autoincrement())
  name       String
  type       String   @default("generic") // monster type/species
  variant    String   @default("normal") // feeble, normal, or mighty
  tier       Int      @default(1) // 1-5 difficulty tier
  hp         Int
  maxHp      Int      @default(50)
  strength   Int      @default(8)
  agility    Int      @default(8)
  health     Int      @default(8)
  damageRoll String   @default("1d6")
  x          Int
  y          Int
  isAlive    Boolean  @default(true)
  lastMove   DateTime @default(now())
  spawnedAt  DateTime @default(now())
  biomeId    Int // References BiomeId enum from @mud/constants
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  // Add more fields as needed (type, loot, etc.)

  @@index([isAlive, x, y])
  @@index([x, y])
}

model WeatherState {
  id        Int      @id @default(autoincrement())
  state     String // e.g., clear, cloudy, overcast, raining, lightning
  pressure  Int // Used for weather change logic
  updatedAt DateTime @updatedAt
}

model Landmark {
  id          Int      @id @default(autoincrement())
  name        String
  type        String // ruins, tower, shrine, etc.
  x           Int
  y           Int
  description String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([x, y])
}

model CombatLog {
  id           Int      @id @default(autoincrement())
  attackerId   Int // Player or Monster ID
  attackerType String // "player" or "monster"
  defenderId   Int // Player or Monster ID
  defenderType String // "player" or "monster"
  damage       Int
  x            Int // Location where combat occurred
  y            Int
  timestamp    DateTime @default(now())
}

model Npc {
  id        Int      @id @default(autoincrement())
  name      String
  role      String // merchant, quest_giver, guard, citizen, innkeeper
  x         Int
  y         Int
  hp        Int
  maxHp     Int      @default(50)
  strength  Int      @default(10)
  agility   Int      @default(10)
  health    Int      @default(10)
  isAlive   Boolean  @default(true)
  isHostile Boolean  @default(false)
  dialogue  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ShopCatalogItem {
  id                     Int                  @id @default(autoincrement())
  sku                    String               @unique
  name                   String               @unique
  description            String               @default("")
  buyPriceGold           Int
  sellPriceGold          Int
  stockQuantity          Int                  @default(0)
  maxStock               Int?
  restockIntervalMinutes Int?
  tags                   String[]
  quality                ItemQuality          @default(Common)
  isActive               Boolean              @default(true)
  itemTemplateId         Int?
  itemTemplate           Item?                @relation(fields: [itemTemplateId], references: [id])
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  transactionReceipts    TransactionReceipt[]
}

model TransactionReceipt {
  id                Int                 @id @default(autoincrement())
  playerId          Int
  player            Player              @relation(fields: [playerId], references: [id], onDelete: Cascade)
  itemId            Int?
  item              ShopCatalogItem?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  playerItemId      Int?
  playerItem        PlayerItem?         @relation(fields: [playerItemId], references: [id], onDelete: SetNull)
  direction         GuildTradeDirection
  goldDelta         Int
  quantity          Int                 @default(1)
  correlationId     String?
  eventBusMessageId String?
  createdAt         DateTime            @default(now())

  @@index([playerId, createdAt])
}

model AnnouncementRecord {
  id              Int                @id @default(autoincrement())
  title           String
  body            String
  digest          String
  priority        Int                @default(0)
  visibleFrom     DateTime           @default(now())
  visibleUntil    DateTime?
  lastAnnouncedAt DateTime?
  status          AnnouncementStatus @default(PENDING)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status, priority, visibleFrom])
}

model Party {
  id        Int           @id @default(autoincrement())
  name      String
  leaderId  Int
  maxSize   Int           @default(6)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  players   Player[]
  members   PartyMember[]
}

model PartyMember {
  id       Int      @id @default(autoincrement())
  party    Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  partyId  Int
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId Int
  isLeader Boolean  @default(false)
  joinedAt DateTime @default(now())

  @@unique([partyId, playerId])
}

model Item {
  id              Int               @id @default(autoincrement())
  name            String
  type            ItemType // weapon, armor
  description     String
  value           Int               @default(0) // Gold value
  damageRoll      String? // Damage dice (e.g. "1d8")
  defense         Int?              @default(0) // Defense bonus for armor
  slot            PlayerSlot? // Optional equip slot for equippable items
  rank            Int?
  playerItems     PlayerItem[]
  worldItems      WorldItem[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ShopCatalogItem ShopCatalogItem[]
}

// Inventory and loot enums/models
enum ItemQuality {
  Trash
  Poor
  Common
  Uncommon
  Fine
  Superior
  Rare
  Epic
  Legendary
  Mythic
  Artifact
  Ascended
  Transcendent
  Primal
  Divine
}

enum PlayerSlot {
  head
  chest
  arms
  legs
  weapon
}

model PlayerItem {
  id                 Int                  @id @default(autoincrement())
  player             Player               @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId           Int
  item               Item                 @relation(fields: [itemId], references: [id])
  itemId             Int
  quantity           Int                  @default(1)
  equipped           Boolean              @default(false)
  slot               PlayerSlot?
  quality            ItemQuality          @default(Common)
  rank               Int?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  TransactionReceipt TransactionReceipt[]

  @@index([playerId])
}

model WorldItem {
  id                 Int         @id @default(autoincrement())
  item               Item        @relation(fields: [itemId], references: [id])
  itemId             Int
  quality            ItemQuality @default(Common)
  rank               Int?
  x                  Int
  y                  Int
  quantity           Int         @default(1)
  spawnedByMonsterId Int?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([x, y])
}

model Feedback {
  id              Int      @id @default(autoincrement())
  playerId        Int
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type            String // bug, suggestion, general (player-selected)
  category        String? // LLM-classified: bug, feature, balance, ux, question, praise
  priority        String? // LLM-assigned: low, medium, high
  content         String // Original feedback text
  summary         String? // LLM-generated summary
  status          String   @default("pending") // pending, submitted, rejected
  rejectionReason String?
  githubIssueUrl  String?
  githubIssueNum  Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([playerId])
  @@index([createdAt])
}

model SlackAppInstallation {
  id                              Int       @id @default(autoincrement())
  clientId                        String?   @map("client_id")
  appId                           String?   @map("app_id")
  enterpriseId                    String?   @map("enterprise_id")
  enterpriseName                  String?   @map("enterprise_name")
  enterpriseUrl                   String?   @map("enterprise_url")
  teamId                          String?   @map("team_id")
  teamName                        String?   @map("team_name")
  botToken                        String?   @map("bot_token")
  botId                           String?   @map("bot_id")
  botUserId                       String?   @map("bot_user_id")
  botScopes                       String?   @map("bot_scopes")
  botRefreshToken                 String?   @map("bot_refresh_token")
  botTokenExpiresAt               DateTime? @map("bot_token_expires_at")
  userId                          String?   @map("user_id")
  userToken                       String?   @map("user_token")
  userScopes                      String?   @map("user_scopes")
  userRefreshToken                String?   @map("user_refresh_token")
  userTokenExpiresAt              DateTime? @map("user_token_expires_at")
  incomingWebhookUrl              String?   @map("incoming_webhook_url")
  incomingWebhookChannel          String?   @map("incoming_webhook_channel")
  incomingWebhookChannelId        String?   @map("incoming_webhook_channel_id")
  incomingWebhookConfigurationUrl String?   @map("incoming_webhook_configuration_url")
  isEnterpriseInstall             Boolean   @default(false) @map("is_enterprise_install")
  tokenType                       String    @default("bot") @map("token_type")
  installedAt                     DateTime  @default(now()) @map("installed_at")
  // This is an example custom property
  memo                            String?

  @@map("slack_app_installation")
}
