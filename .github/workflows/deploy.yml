name: Deploy to GCP

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      apps:
        description: 'Apps to deploy (comma-separated: dm,slack-bot,tick,world or "all")'
        required: false
        default: 'all'
        type: string
      deploy_infrastructure:
        description: 'Deploy infrastructure changes (Terraform)'
        required: false
        default: false
        type: boolean

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  REGISTRY: ${{ secrets.GCP_REGION }}-docker.pkg.dev
  ARTIFACT_REPO: mud-registry

permissions:
  contents: read
  id-token: write

jobs:
  # Determine which apps are affected by changes
  detect-changes:
    name: Detect affected applications
    runs-on: ubuntu-latest
    outputs:
      affected-apps: ${{ steps.affected.outputs.apps }}
      affected-packages: ${{ steps.affected.outputs.packages }}
      has-affected-apps: ${{ steps.affected.outputs.has-apps }}
      has-affected-packages: ${{ steps.affected.outputs.has-packages }}
      infra-changed: ${{ steps.check-infra.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Get affected applications
        id: affected
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ./scripts/ci/detect-affected-apps.sh manual "${{ inputs.apps }}" "$GITHUB_OUTPUT"
          else
            ./scripts/ci/detect-affected-apps.sh auto "" "$GITHUB_OUTPUT"
          fi

      - name: Check infrastructure changes
        id: check-infra
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ./scripts/ci/check-infra-changes.sh manual "${{ inputs.deploy_infrastructure }}" "" "" "$GITHUB_OUTPUT"
          else
            ./scripts/ci/check-infra-changes.sh auto "" "${{ github.event.before }}" "${{ github.sha }}" "$GITHUB_OUTPUT"
          fi

  # Apply Terraform changes if infrastructure was affected
  terraform:
    name: Apply Terraform
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.infra-changed == 'true'
    environment: Production
    defaults:
      run:
        working-directory: infra/terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.9.0'

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="prefix=${{ secrets.TF_BACKEND_PREFIX }}"

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -input=false \
            -var="project_id=${{ env.GCP_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -var="image_version=${{ github.sha }}" \
            -out=tfplan \
            -no-color
        continue-on-error: true

      - name: Check for changes
        id: check-changes
        run: |
          if terraform show -no-color tfplan | grep -q "No changes"; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "No infrastructure changes to apply"
          else
            echo "has-changes=true" >> $GITHUB_OUTPUT
            echo "Infrastructure changes detected in plan"
          fi

      - name: Terraform Apply
        if: steps.check-changes.outputs.has-changes == 'true'
        run: terraform apply -auto-approve tfplan

  # Build and push Docker images for affected apps
  build-and-push:
    name: Build and push ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform]
    environment: Production
    if: |
      always() && 
      needs.detect-changes.outputs.has-affected-apps == 'true' &&
      (needs.terraform.result == 'success' || needs.terraform.result == 'skipped')
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-changes.outputs.affected-apps) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and push Docker image
        run: ./scripts/ci/build-and-push-docker.sh "${{ matrix.app }}" "${{ env.REGISTRY }}" "${{ env.GCP_PROJECT_ID }}" "${{ env.ARTIFACT_REPO }}" "${{ github.sha }}"

      - name: Deploy to Cloud Run
        run: ./scripts/ci/deploy-to-cloudrun.sh "${{ matrix.app }}" "${{ env.REGISTRY }}" "${{ env.GCP_PROJECT_ID }}" "${{ env.ARTIFACT_REPO }}" "${{ github.sha }}" "${{ env.GCP_REGION }}"

  # Summary job to report deployment status
  deploy-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, terraform, build-and-push]
    if: always()
    steps:
      - name: Report Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.infra-changed }}" == "true" ]; then
            echo "### 🏗️ Infrastructure" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.terraform.result }}" == "success" ]; then
              echo "✅ Terraform applied successfully" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.terraform.result }}" == "skipped" ]; then
              echo "⏭️ Terraform skipped (no changes)" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Terraform failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### 🚀 Applications" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.detect-changes.outputs.has-affected-apps }}" == "true" ]; then
            echo "Affected apps: ${{ needs.detect-changes.outputs.affected-apps }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.build-and-push.result }}" == "success" ]; then
              echo "✅ All applications deployed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ Some applications failed to deploy" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ No applications affected by this push" >> $GITHUB_STEP_SUMMARY
          fi
