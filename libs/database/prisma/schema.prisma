// Prisma schema for the dungeon crawler game engine
// This schema covers players, monsters, items, and shop data.

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [citext]
}

enum GuildTradeDirection {
  BUY
  SELL
}

enum ItemType {
  WEAPON
  ARMOR
}

enum AnnouncementStatus {
  PENDING
  ANNOUNCED
  EXPIRED
}

enum RunType {
  SOLO
  GUILD
}

enum RunStatus {
  ACTIVE
  CASHED_OUT
  FAILED
}

model Player {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique @db.Citext
  hp                 Int // Hit points (current health)
  maxHp              Int                  @default(100) // Maximum health
  strength           Int                  @default(10) // Strength attribute (1-20)
  agility            Int                  @default(10) // Agility attribute (1-20)
  health             Int                  @default(10) // Health attribute (1-20, affects max HP)
  gold               Int                  @default(0)
  rareTickets        Int                  @default(0)
  epicTickets        Int                  @default(0)
  legendaryTickets   Int                  @default(0)
  xp                 Int                  @default(0)
  level              Int                  @default(1)
  skillPoints        Int                  @default(0)
  isAlive            Boolean              @default(true)
  isCreationComplete Boolean              @default(false) // Tracks if character creation is complete (no more rerolls/complete allowed)
  lastAction         DateTime             @default(now())
  lastActiveAt       DateTime             @default(now())
  hasStartedGame     Boolean              @default(false)
  hasMoved           Boolean              @default(false)
  hasBattled         Boolean              @default(false)
  hasDefeatedMonster Boolean              @default(false)
  totalCommandsExecuted Int               @default(0)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  party              Party?               @relation(fields: [partyId], references: [id])
  partyId            Int?
  partyMembers       PartyMember[]
  playerItems        PlayerItem[]
  slackUser          SlackUser?
  guildMembership    GuildMember?
  guildInvitesSent   GuildInvite[]        @relation("GuildInviteSender")
  guildInvitesReceived GuildInvite[]      @relation("GuildInviteRecipient")
  guildReceipts      TransactionReceipt[]
  feedbacks          Feedback[]
  runParticipants    RunParticipant[]
  runsLed            Run[]                @relation("RunLeader")
  // Future: discordUsers DiscordUser[], webUsers WebUser[], etc.
}

model SlackUser {
  id        Int      @id @default(autoincrement())
  teamId    String // Slack workspace/team ID (e.g., "TB1QW3SQHU")
  userId    String // Slack user ID (e.g., "UB389SP46")
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model Guild {
  id        Int      @id @default(autoincrement())
  teamId    String
  name      String   @db.Citext
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members   GuildMember[]
  invites   GuildInvite[]
  runs      Run[]

  @@unique([teamId, name])
  @@index([teamId])
}

model GuildMember {
  id        Int      @id @default(autoincrement())
  guild     Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  guildId   Int
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  Int
  isLeader  Boolean  @default(false)
  joinedAt  DateTime @default(now())

  @@unique([guildId, playerId])
  @@unique([playerId])
  @@index([guildId])
}

model GuildInvite {
  id               Int      @id @default(autoincrement())
  guild            Guild    @relation(fields: [guildId], references: [id], onDelete: Cascade)
  guildId          Int
  inviter          Player   @relation("GuildInviteSender", fields: [inviterPlayerId], references: [id], onDelete: Cascade)
  inviterPlayerId  Int
  invitee          Player   @relation("GuildInviteRecipient", fields: [inviteePlayerId], references: [id], onDelete: Cascade)
  inviteePlayerId  Int
  createdAt        DateTime @default(now())

  @@unique([guildId, inviteePlayerId])
  @@index([inviteePlayerId])
}

model Run {
  id             Int        @id @default(autoincrement())
  runType        RunType
  status         RunStatus  @default(ACTIVE)
  round          Int        @default(0)
  bankedXp       Int        @default(0)
  bankedGold     Int        @default(0)
  difficultyTier Int        @default(1)
  leader         Player     @relation("RunLeader", fields: [leaderPlayerId], references: [id], onDelete: Restrict)
  leaderPlayerId Int
  guild          Guild?     @relation(fields: [guildId], references: [id], onDelete: SetNull)
  guildId        Int?
  participants   RunParticipant[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  endedAt        DateTime?

  @@index([status])
  @@index([leaderPlayerId])
  @@index([guildId])
}

model RunParticipant {
  id        Int      @id @default(autoincrement())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId     Int
  player    Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId  Int
  isLeader  Boolean  @default(false)
  joinedAt  DateTime @default(now())

  @@unique([runId, playerId])
  @@index([playerId])
}

model Monster {
  id         Int      @id @default(autoincrement())
  name       String
  type       String   @default("generic") // monster type/species
  variant    String   @default("normal") // feeble, normal, or mighty
  tier       Int      @default(1) // 1-5 difficulty tier
  hp         Int
  maxHp      Int      @default(50)
  strength   Int      @default(8)
  agility    Int      @default(8)
  health     Int      @default(8)
  damageRoll String   @default("1d6")
  isAlive    Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  // Add more fields as needed (type, loot, etc.)

  @@index([isAlive])
}
model CombatLog {
  id           Int      @id @default(autoincrement())
  combatId     String?  @unique
  attackerId   Int // Player or Monster ID
  attackerType String // "player" or "monster"
  defenderId   Int // Player or Monster ID
  defenderType String // "player" or "monster"
  damage       Int
  log          Json?
  runId        Int?
  runRound     Int?
  timestamp    DateTime @default(now())
}

model ShopCatalogItem {
  id                     Int                  @id @default(autoincrement())
  sku                    String               @unique
  name                   String               @unique
  refreshId              String               @default("")
  tier                   Int                  @default(1)
  offsetK                Int                  @default(0)
  itemPower              Int                  @default(0)
  strengthBonus          Int                  @default(0)
  agilityBonus           Int                  @default(0)
  healthBonus            Int                  @default(0)
  weaponDiceCount        Int?
  weaponDiceSides        Int?
  archetype              String?
  ticketRequirement      TicketTier?
  description            String               @default("")
  buyPriceGold           Int
  sellPriceGold          Int
  stockQuantity          Int                  @default(0)
  maxStock               Int?
  restockIntervalMinutes Int?
  tags                   String[]
  quality                ItemQuality          @default(Common)
  isActive               Boolean              @default(true)
  itemTemplateId         Int?
  itemTemplate           Item?                @relation(fields: [itemTemplateId], references: [id])
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
  transactionReceipts    TransactionReceipt[]
}

model TransactionReceipt {
  id                Int                 @id @default(autoincrement())
  playerId          Int
  player            Player              @relation(fields: [playerId], references: [id], onDelete: Cascade)
  itemId            Int?
  item              ShopCatalogItem?    @relation(fields: [itemId], references: [id], onDelete: SetNull)
  playerItemId      Int?
  playerItem        PlayerItem?         @relation(fields: [playerItemId], references: [id], onDelete: SetNull)
  direction         GuildTradeDirection
  goldDelta         Int
  quantity          Int                 @default(1)
  correlationId     String?
  eventBusMessageId String?
  createdAt         DateTime            @default(now())

  @@index([playerId, createdAt])
}

model GuildShopState {
  id                   Int      @id @default(autoincrement())
  refreshId            String
  refreshesSinceChase  Int      @default(0)
  globalTier           Int      @default(1)
  medianLevel          Int      @default(1)
  lastRefreshedAt      DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

model AnnouncementRecord {
  id              Int                @id @default(autoincrement())
  title           String
  body            String
  digest          String
  priority        Int                @default(0)
  visibleFrom     DateTime           @default(now())
  visibleUntil    DateTime?
  lastAnnouncedAt DateTime?
  status          AnnouncementStatus @default(PENDING)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status, priority, visibleFrom])
}

model Party {
  id        Int           @id @default(autoincrement())
  name      String
  leaderId  Int
  maxSize   Int           @default(6)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  players   Player[]
  members   PartyMember[]
}

model PartyMember {
  id       Int      @id @default(autoincrement())
  party    Party    @relation(fields: [partyId], references: [id], onDelete: Cascade)
  partyId  Int
  player   Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId Int
  isLeader Boolean  @default(false)
  joinedAt DateTime @default(now())

  @@unique([partyId, playerId])
}

model Item {
  id              Int               @id @default(autoincrement())
  name            String
  type            ItemType // weapon, armor
  description     String
  value           Int               @default(0) // Gold value
  damageRoll      String? // Damage dice (e.g. "1d8")
  defense         Int?              @default(0) // Defense bonus for armor
  slot            PlayerSlot? // Optional equip slot for equippable items
  itemPower       Int?
  tier            Int?
  strengthBonus   Int               @default(0)
  agilityBonus    Int               @default(0)
  healthBonus     Int               @default(0)
  weaponDiceCount Int?
  weaponDiceSides Int?
  rank            Int?
  playerItems     PlayerItem[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  ShopCatalogItem ShopCatalogItem[]
}

// Inventory and loot enums/models
enum ItemQuality {
  Trash
  Poor
  Common
  Uncommon
  Fine
  Superior
  Rare
  Epic
  Legendary
  Mythic
  Artifact
  Ascended
  Transcendent
  Primal
  Divine
}

enum TicketTier {
  Rare
  Epic
  Legendary
}

enum PlayerSlot {
  head
  chest
  arms
  legs
  weapon
}

model PlayerItem {
  id                 Int                  @id @default(autoincrement())
  player             Player               @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId           Int
  item               Item                 @relation(fields: [itemId], references: [id])
  itemId             Int
  quantity           Int                  @default(1)
  equipped           Boolean              @default(false)
  slot               PlayerSlot?
  quality            ItemQuality          @default(Common)
  rank               Int?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  TransactionReceipt TransactionReceipt[]

  @@index([playerId])
}

model Feedback {
  id              Int      @id @default(autoincrement())
  playerId        Int
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type            String // bug, suggestion, general (player-selected)
  category        String? // LLM-classified: bug, feature, balance, ux, question, praise
  priority        String? // LLM-assigned: low, medium, high
  content         String // Original feedback text
  summary         String? // LLM-generated summary
  status          String   @default("pending") // pending, submitted, rejected
  rejectionReason String?
  githubIssueUrl  String?
  githubIssueNum  Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([playerId])
  @@index([createdAt])
}

model SlackAppInstallation {
  id                              Int       @id @default(autoincrement())
  clientId                        String?   @map("client_id")
  appId                           String?   @map("app_id")
  enterpriseId                    String?   @map("enterprise_id")
  enterpriseName                  String?   @map("enterprise_name")
  enterpriseUrl                   String?   @map("enterprise_url")
  teamId                          String?   @map("team_id")
  teamName                        String?   @map("team_name")
  botToken                        String?   @map("bot_token")
  botId                           String?   @map("bot_id")
  botUserId                       String?   @map("bot_user_id")
  botScopes                       String?   @map("bot_scopes")
  botRefreshToken                 String?   @map("bot_refresh_token")
  botTokenExpiresAt               DateTime? @map("bot_token_expires_at")
  userId                          String?   @map("user_id")
  userToken                       String?   @map("user_token")
  userScopes                      String?   @map("user_scopes")
  userRefreshToken                String?   @map("user_refresh_token")
  userTokenExpiresAt              DateTime? @map("user_token_expires_at")
  incomingWebhookUrl              String?   @map("incoming_webhook_url")
  incomingWebhookChannel          String?   @map("incoming_webhook_channel")
  incomingWebhookChannelId        String?   @map("incoming_webhook_channel_id")
  incomingWebhookConfigurationUrl String?   @map("incoming_webhook_configuration_url")
  isEnterpriseInstall             Boolean   @default(false) @map("is_enterprise_install")
  tokenType                       String    @default("bot") @map("token_type")
  installedAt                     DateTime  @default(now()) @map("installed_at")
  // This is an example custom property
  memo                            String?

  @@map("slack_app_installation")
}

model Workspace {
  id            Int      @id @default(autoincrement())
  workspaceId   String   @unique
  installedAt   DateTime @default(now())
  uninstalledAt DateTime?
  lastActiveAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([workspaceId])
}
